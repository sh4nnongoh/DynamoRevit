<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi"
     xmlns:util="http://schemas.microsoft.com/wix/UtilExtension">

  <Product Id="6F1B7397-5DED-400D-90BE-135E05091DB4"
           Name="$(var.ProductName) $(var.Major).$(var.Minor).$(var.Rev)"
           Language="1033"
           Version="$(var.Major).$(var.Minor).$(var.Rev)"
           Manufacturer="Dynamo"
           UpgradeCode="2baac14c-bcc4-423b-baec-7b3acecd6d13">

    <Package InstallerVersion="400"
             Compressed="yes"
             InstallScope="perMachine"
             Platform="x64"/>

    <MajorUpgrade
      Schedule="afterInstallInitialize"
      DowngradeErrorMessage="A newer version of [ProductName] is already installed." />

    <!-- License agreement text: dummy. Real text is set in WXS file -->
    <WixVariable Id="WixUILicenseRtf" Value="dummy" />

    <!-- UI customization -->
    <WixVariable Id="WixUIBannerBmp" Value="images\BannerTop.bmp" />
    <WixVariable Id="WixUIDialogBmp" Value="images\Dialog.bmp" />

    <!-- Define icons (ID should not be longer than 18 chars and must end with ".exe") -->
    <Icon Id="Icon.exe" SourceFile="images\app.ico" />

    <!-- Set properties for add/remove programs -->
    <Property Id="ARPPRODUCTICON" Value="Icon.exe" />
    <Property Id="ARPHELPLINK" Value="$(var.InfoURL)" />
    <Property Id="ARPNOREPAIR" Value="yes" Secure="yes" /><!-- Remove repair -->
    <Property Id="ARPNOMODIFY" Value="yes" Secure="yes" /><!-- Remove modify -->

    <Property Id="DYNAMOLOCATION">
      <RegistrySearch Id='DynamoRegistry' Type='raw' Win64='yes'
        Root='HKLM' Key='SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\Dynamo $(var.Major).$(var.Minor)' Name='InstallLocation' />
    </Property>

    <!--Property used to define on which version of Revit to install.-->
    <Property Id="INSTALL_FOR_REVIT_2014">1</Property>
    <Property Id="INSTALL_FOR_REVIT_2015">1</Property>

    <!--Find Revit installations by finding the uninstall registry key.-->

    <Property Id="REVIT_2015">
      <RegistrySearch Id='RevitRegistry_2015' Type='raw' Win64='yes'
        Root='HKLM' Key='SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\Autodesk Revit 2015' Name='InstallLocation' />
    </Property>

    <Property Id="REVIT_ARCHITECTURE_2015">
      <RegistrySearch Id='RevitRegistry_Architecture_2015' Type='raw' Win64='yes'
        Root='HKLM' Key='SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\Autodesk Revit Architecture 2015' Name='InstallLocation' />
    </Property>

    <Property Id='DYNAMOREVIT_INSTALLDIR'></Property>
    <SetProperty Id="DYNAMOREVIT_INSTALLDIR" Value="[ProgramFiles64Folder]\$(var.ProductName) $(var.Major).$(var.Minor)" After="LaunchConditions"></SetProperty>

    <Icon Id="DynamoInstaller.ico" SourceFile="$(var.base)\tools\install\Extra\DynamoInstaller.ico"/>
    <Property Id="ARPPRODUCTICON" Value="DynamoInstaller.ico" />

    <!-- We do not have more than one medium (Floppy, CD, ...). Everything in one file. -->
    <Media Id="1" Cabinet="media1.cab" EmbedCab="yes" />

    <!-- This is the main installer sequence run when the product is actually installed -->
    <InstallExecuteSequence>
      <!-- Determine the install location after the install path has been validated by the installer -->
      <Custom Action="SetARPINSTALLLOCATION" After="InstallValidate"></Custom>
    </InstallExecuteSequence>

    <!-- Set up ARPINSTALLLOCATION property (http://blogs.technet.com/b/alexshev/archive/2008/02/09/from-msi-to-wix-part-2.aspx) -->
    <CustomAction Id="SetARPINSTALLLOCATION" Property="ARPINSTALLLOCATION" Value="[INSTALLDIR]" />

    <!--================-->
    <CustomAction Id="GenerateRevitAddin.SetProperty" Property="GenerateRevitAddin"
                  Value="&quot;[DYNAMOREVIT_INSTALLDIR]\DynamoAddinGenerator.exe&quot; &quot;[ProgramFiles64Folder]\Dynamo $(var.Major).$(var.Minor)&quot;" />
    <CustomAction Id="GenerateRevitAddin" Return="ignore" BinaryKey="WixCA" DllEntry="CAQuietExec" Execute="deferred" Impersonate="no" />

    <CustomAction Id="RemoveRevitAddin.SetProperty" Property="RemoveRevitAddin"
                  Value="&quot;[DYNAMOREVIT_INSTALLDIR]\DynamoAddinGenerator.exe&quot; /uninstall &quot;[ProgramFiles64Folder]\Dynamo $(var.Major).$(var.Minor)&quot;" />
    <CustomAction Id="RemoveRevitAddin" Return="ignore" BinaryKey="WixCA" DllEntry="CAQuietExec" Execute="deferred" Impersonate="no" />

    <InstallExecuteSequence>
      <Custom Action="RemoveRevitAddin.SetProperty" Before="InstallFinalize">Installed</Custom>
      <Custom Action="RemoveRevitAddin" After="RemoveRevitAddin.SetProperty">Installed</Custom>
      <Custom Action="GenerateRevitAddin.SetProperty" After="RemoveRevitAddin">NOT Installed</Custom>
      <Custom Action="GenerateRevitAddin" After="GenerateRevitAddin.SetProperty">NOT Installed</Custom>
    </InstallExecuteSequence>
    <!-- 
       Launch conditions
 
       1. Check if a specific DynamoCore.msi version is installed.
    -->
    <Condition Message="DynamoCore.msi version [ProductVersion] is not installed on this system.">
      <![CDATA[DYNAMOLOCATION]]>
    </Condition>
    <!--================-->

    <!--================-->
    <Feature Id="DYNAMO_REVIT_FEATURE"
             Title="Dynamo for Revit"
             Level="1">
      <ComponentGroupRef Id="RELEASE"/>
      <ComponentRef Id="ProductRegistry" />
      <Feature Id="DYNAMO_REVIT_SAMPLES"
             Title="Sample Content"
             Level="1" >
        <ComponentGroupRef Id="SAMPLES"/>
      </Feature>
    </Feature>

    <Feature Id="DYNAMO_REVIT_2015"
             Title="Dynamo for Revit 2015"
             Level="1">
      <ComponentGroupRef Id="REVIT_2015"/>
      <Condition Level="0">(REVIT_2015="" AND REVIT_ARCHITECTURE_2015="") OR INSTALL_FOR_REVIT_2015=0</Condition>
    </Feature>
    <!--================-->
  </Product>

  <Fragment>
    <Directory Id="TARGETDIR" Name="SourceDir">
      <Directory Id="ProgramMenuFolder">
      </Directory>
      <Directory Id="DYNAMOREVIT_INSTALLDIR"/>
      <Directory Id="CommonAppDataFolder">
        <Directory Id="ADESK_DATA" Name="Autodesk">
          <Directory Id="REVIT_DATA" Name="Revit">
            <Directory Id="ADDIN_DATA" Name="Addins">
              <Directory Id="ADDINS_2015" Name="2015">
              </Directory>
            </Directory>
          </Directory>
        </Directory>
        <Directory Id="DYNAMO_PROGDATA" Name="Dynamo">
          <Directory Id="PROGDATA" Name="$(var.Major).$(var.Minor)"/>
        </Directory>
      </Directory>
    </Directory>

    <DirectoryRef Id="TARGETDIR">
      <Component Id="ProductRegistry" Win64="yes">
        <RegistryKey Root="HKLM"
                     Key="SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\$(var.ProductName) $(var.Major).$(var.Minor)"
                     ForceDeleteOnUninstall="yes">
          <RegistryValue Name="InstallLocation" Value="[DYNAMOREVIT_INSTALLDIR]" Type="string" />
          <RegistryValue Name="UninstallString" Value="MsiExec.exe" Type="string" />
          <RegistryValue Name="UninstallParam" Value="/X[ProductCode] /quiet" Type="string" />
          <RegistryValue Name="Version" Value="$(var.FullVersion)" Type="string" />
          <RegistryValue Name="RevVersion" Value="$(var.Rev)" Type="integer" />
        </RegistryKey>
      </Component>
    </DirectoryRef>

    <ComponentGroup Id="REVIT_2015" Directory="ADDINS_2015">
      <Component Id="DynamoForRevit2015.addin" Guid="fde9dc0b-4b8c-46d3-9950-42c9f66b5e60">
        <File Id="DynamoForRevit2015.addin" Name="Dynamo.addin" Source="$(var.base)\tools\install\Extra\DynamoForRevit2015.addin"></File>
      </Component>
    </ComponentGroup>

  </Fragment>
  
</Wix>
