<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi"
     xmlns:util="http://schemas.microsoft.com/wix/UtilExtension">

  <Product Id="*"
           Name="$(var.ProductName) $(var.Major).$(var.Minor).$(var.Build)"
           Language="1033"
           Version="$(var.FullVersion)"
           Manufacturer="$(var.Manufacturer)"
           UpgradeCode="$(var.UpgradeCode)">

    <Package Comments="$(var.ProductName) $(var.FullVersion)"
             Description="Install package for $(var.ProductName)"
             InstallerVersion="400"
             Compressed="yes"
             Languages="1033"
             Manufacturer="Dynamo"
             Platform="x64"/>

    <!-- (1) To prevent downgrades. 
         If there are any MAJOR.MINOR.BUILD version that is higher installed,
         prevent current installation.-->
    <MajorUpgrade AllowSameVersionUpgrades="no"
                  Schedule="afterInstallValidate"
                  DowngradeErrorMessage="A newer version of $(var.ProductName) is already installed." />

    <!-- (2) To manage same version upgrades/downgrades.
         The property SELF_FOUND is set when the same MAJOR.MINOR.BUILD version and UpgradeCode is already installed.-->
    <Upgrade Id="$(var.UpgradeCode)">
      <UpgradeVersion Property='SELF_FOUND' 
                      Minimum='$(var.Major).$(var.Minor).$(var.Build)' 
                      IncludeMinimum='yes' 
                      Maximum='$(var.Major).$(var.Minor).$(var.Build)' 
                      IncludeMaximum='yes' 
                      OnlyDetect='yes' />
    </Upgrade>

    <MediaTemplate EmbedCab="yes" />

    <?include Conditions.wxi ?>
    <?include ControlPanel.wxi ?>
    <?include Autodesk.wxi ?>

    <Property Id="DYNAMOLOCATION">
      <RegistrySearch Id='DynamoRegistry' Type='raw' Win64='yes'
        Root='HKLM' Key='SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\Dynamo Core $(var.Major).$(var.Minor)' Name='InstallLocation' />
    </Property>

    <Property Id="SAMPLEFOLDER">
      <RegistrySearch Root="HKLM" Key="SOFTWARE\[Manufacturer]\$(var.ProductName)\[Manufacturer] [ProductName]" Type="raw" Id="SAMPLES_REGSEARCH" Name="SamplesPath" Win64="yes" />
    </Property>
    
    <Property Id="SELECT_REVIT_2015"/>
    <Property Id="SELECT_REVIT_2016"/>
    <Property Id="SELECT_REVIT_2017"/>

    <Property Id="INSTALLDIR"/>
    <CustomAction Id="DIRCA_DEFAULT_INSTALLDIR" Property="DYNAMO_REVIT_INSTALLDIR" Value="[ProgramFiles64Folder][Manufacturer]\$(var.ProductName)\$(var.Major).$(var.Minor)" Execute="immediate" />
    <CustomAction Id="DIRCA_SET_INSTALLDIR" Property="DYNAMO_REVIT_INSTALLDIR" Value="[INSTALLDIR]\$(var.ProductName)\$(var.Major).$(var.Minor)" Execute="immediate" />
    
    <CustomAction Id="GenerateDynamoAddin.SetProperty" Property="GenerateDynamoAddin"
                  Value="&quot;[DYNAMO_REVIT_INSTALLDIR]DynamoAddinGenerator.exe&quot;" />
    <CustomAction Id="GenerateDynamoAddin" Return="ignore" BinaryKey="WixCA" DllEntry="CAQuietExec" Execute="deferred" Impersonate="no" />

    <CustomAction Id="RemoveDynamoAddin.SetProperty" Property="RemoveDynamoAddin"
                  Value="&quot;[DYNAMO_REVIT_INSTALLDIR]DynamoAddinGenerator.exe&quot; /uninstall &quot;[DYNAMO_REVIT_INSTALLDIR]\&quot;" />
    <CustomAction Id="RemoveDynamoAddin" Return="ignore" BinaryKey="WixCA" DllEntry="CAQuietExec" Execute="deferred" Impersonate="no" />

    <CustomAction Id='AlreadyInstalled' Error='[ProductName] is already installed.&#13;&#10;&#13;&#10;Skipping [ProductName] Installation...' />

    <InstallExecuteSequence>
      <Custom Action='AlreadyInstalled' Before="CostInitialize"><![CDATA[SELF_FOUND]]></Custom>
      <Custom Action="DIRCA_DEFAULT_INSTALLDIR" Before="CostInitialize">INSTALLDIR=""</Custom>
      <Custom Action="DIRCA_SET_INSTALLDIR" Before="CostInitialize"><![CDATA[INSTALLDIR<>""]]></Custom>
      <Custom Action="GenerateDynamoAddin.SetProperty" Before="GenerateDynamoAddin">NOT REMOVE="ALL"</Custom>
      <Custom Action="GenerateDynamoAddin" Before="InstallFinalize">NOT REMOVE="ALL"</Custom>
      <Custom Action="RemoveDynamoAddin.SetProperty" Before="RemoveDynamoAddin">REMOVE="ALL"</Custom>
      <Custom Action="RemoveDynamoAddin" After="InstallInitialize">REMOVE="ALL"</Custom>
    </InstallExecuteSequence>


    <Feature Id="DYNAMO_REVIT_FEATURE"
             Title="Dynamo Revit"
             Level="1">
      
      <ComponentGroupRef Id="RELEASE"/>
      <ComponentGroupRef Id="DEFINITIONS"/>
      <ComponentGroupRef Id="GALLERY"/>
      <ComponentRef Id="ProductRegistry" />
      
      <Feature Id="DYNAMO_REVIT_2015" Title="Dynamo Revit 2015" Level="0" >
        <ComponentGroupRef Id="REVIT_2015"/>
        <Condition Level="1">
          (SELECT_REVIT_2015="" AND SELECT_REVIT_2016="" AND SELECT_REVIT_2017="")
          OR SELECT_REVIT_2015=1
        </Condition>
      </Feature>

      <Feature Id="DYNAMO_REVIT_2016" Title="Dynamo Revit 2016" Level="0" >
        <ComponentGroupRef Id="REVIT_2016"/>
        <Condition Level="1">
          (SELECT_REVIT_2015="" AND SELECT_REVIT_2016="" AND SELECT_REVIT_2017="")
          OR SELECT_REVIT_2016=1
        </Condition>
      </Feature>

      <Feature Id="DYNAMO_REVIT_2017" Title="Dynamo Revit 2017" Level="0" >
        <ComponentGroupRef Id="REVIT_2017"/>
        <Condition Level="1">
          (SELECT_REVIT_2015="" AND SELECT_REVIT_2016="" AND SELECT_REVIT_2017="")
          OR SELECT_REVIT_2017=1
        </Condition>
      </Feature>

      <Feature Id="DYNAMO_REVIT_SAMPLES" Title="Sample Content" Level="1" >
        <ComponentGroupRef Id="SAMPLES"/>
      </Feature>
      
      <MergeRef Id="Setup"/> 
	    <MergeRef Id="SetupUninstall"/>
      
    </Feature> 
  
  </Product>

  <Fragment>
    
    <Directory Id="TARGETDIR" Name="SourceDir">
      <Directory Id="DYNAMO_REVIT_INSTALLDIR"/>

      <Merge Id="Setup" Language="1033" SourceFile="$(var.modules)\Setup.msm" DiskId="1">
			  <ConfigurationData Name="_9F0C03F7CF754E429FF686DE8D9B85AC.EA84BDA4715A43B6B1DEDE5ED0070F0E" Value="[DYNAMO_REVIT_INSTALLDIR]" />
      </Merge>
	    <Merge Id="SetupUninstall" Language="1033" SourceFile="$(var.modules)\SetupUninstall.msm" DiskId="1">
		    <ConfigurationData Name="UninstallKeysGUIDConfig" Value="{03D59716-3909-4AC8-850F-16CF66E6BE8B}" />
	    </Merge>

      <Directory Id="CommonAppDataFolder">
        <Directory Id="DYNAMO_PROGDATA" Name="$(var.Manufacturer)">
          <Directory Id="DYNAMO_REVIT_PROGDATA" Name="$(var.ProductName)">
            <Directory Id="PROGDATA" Name="$(var.Major).$(var.Minor)">
            </Directory>
          </Directory>
        </Directory>
      </Directory>

      <Directory Id="AppDataFolder">
        <Directory Id="DYNAMO_APPDATA" Name="$(var.Manufacturer)">
          <Directory Id="DYNAMO_REVIT_APPDATA" Name="$(var.ProductName)">
            <Directory Id="APPDATA" Name="$(var.Major).$(var.Minor)">
              <Directory Id="definitions" Name="definitions" />
              <Directory Id="logs" Name="Logs" />
              <Directory Id="packages" Name="packages" />
            </Directory>
          </Directory>
        </Directory>
      </Directory>
    </Directory>

    <DirectoryRef Id="TARGETDIR">
      <Component Id="ProductRegistry" Win64="yes" Guid="{15019D1A-1F0C-4061-87BE-8349846F9B80}">
        <RegistryKey Root="HKLM"
                     Key="SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\$(var.ProductName) $(var.Major).$(var.Minor)"
                     ForceDeleteOnUninstall="yes">
          <RegistryValue Name="InstallLocation" Value="[DYNAMO_REVIT_INSTALLDIR]" Type="string" />
          <RegistryValue Name="UninstallString" Value="MsiExec.exe" Type="string" />
          <RegistryValue Name="UninstallParam" Value="/X[ProductCode] /quiet" Type="string" />
          <RegistryValue Name="Version" Value="$(var.Major).$(var.Minor).$(var.Build)" Type="string" />
          <RegistryValue Name="RevVersion" Value="$(var.Rev)" Type="integer" />
        </RegistryKey>

        <CreateFolder Directory="definitions" />
        <CreateFolder Directory="logs" />
        <CreateFolder Directory="packages" />

        <RemoveFolder Id="RemoveDefinitionsDir" Directory="definitions" On="uninstall" />
        <RemoveFolder Id="RemoveLogsDir" Directory="logs" On="uninstall" />
        <RemoveFolder Id="RemovePackagesDir" Directory="packages" On="uninstall" />
        <RemoveFolder Id="RemoveAppDataDir" Directory="APPDATA" On="uninstall" />
        <RemoveFolder Id="RemoveDynamoRevitAppDataDir" Directory="DYNAMO_REVIT_APPDATA" On="uninstall" />
        <RemoveFolder Id="RemoveDynamoAppDataDir" Directory="DYNAMO_APPDATA" On="uninstall" />
      </Component>
    </DirectoryRef>
  
  </Fragment>
</Wix>
